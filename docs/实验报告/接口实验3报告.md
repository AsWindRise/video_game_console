# 实验报告单

**实验名称：** 5. 可编程定时器/计数器8253应用实验

**实验室：** 产教融合大楼A301/通识机房508
**时间：** 2025.11.27

---

## 实验项目

### 一、实验目的

1. 掌握8253可编程定时器/计数器芯片的工作原理和使用方法；
2. 学会8253的初始化编程方法，正确设置控制字和计数初值；
3. 掌握8253三种工作方式（方式0、方式2、方式3）的应用；
4. 理解8253级联分频的原理和实现方法；
5. 掌握NMI中断的使用方法；
6. 理解BCD计数方式的应用场景。

---

### 二、8253端口地址

本实验中8253基地址为210H，各端口地址如下：

| 端口     | 地址  | 功能说明                |
|----------|-------|------------------------|
| 计数器0  | 210H  | Counter 0 数据端口      |
| 计数器1  | 212H  | Counter 1 数据端口      |
| 计数器2  | 214H  | Counter 2 数据端口      |
| 控制字   | 216H  | 控制寄存器             |

---

### 三、实验步骤

#### 实验一：8253级联分频

1. 在Proteus中搭建硬件电路（8086、8253、信号源等）
2. 配置8253：Counter 0（方式3，BCD，÷1000），Counter 1（方式2，BCD，÷100）
3. 编写程序：设置控制字，写入计数初值
4. 编译并启动仿真，测试分频效果

#### 实验二：LED流水灯定时控制

1. 在Proteus中搭建硬件电路（8086、8253、74LS273、LED、NMI电路等）
2. 配置8253：Counter 0（方式3，÷100），Counter 2（方式0，÷1000）
3. 编写程序：设置中断向量表，配置8253，实现NMI中断服务程序
4. 编译并启动仿真，测试LED流水灯效果

---

### 四、实验代码

#### 实验一代码：8253级联分频

```assembly
;============================================================
; 8253级联分频程序 - 8086汇编
;
; 硬件配置:
;   - 8253可编程定时器/计数器芯片 (基址: 210H)
;   - Counter 0: CLK0输入1MHz时钟，OUT0输出1kHz
;   - Counter 1: CLK1接Counter 0的OUT0，OUT1输出10Hz
;
; 功能描述:
;   实现100,000分频 (1MHz → 10Hz)
;   Counter 0: 方式3，BCD计数，÷1000
;   Counter 1: 方式2，BCD计数，÷100
;============================================================

;============================================================
; 常量定义
;============================================================

; 8253端口地址
PORT_8253_C0    EQU 210H        ; Counter 0 数据端口
PORT_8253_C1    EQU 212H        ; Counter 1 数据端口
PORT_8253_C2    EQU 214H        ; Counter 2 数据端口
PORT_8253_CTRL  EQU 216H        ; 控制字寄存器

; 8253控制字
; Counter 0 控制字 = 0011 0111B = 37H
;   D7-D6 = 00: 选择Counter 0
;   D5-D4 = 11: 读写方式：先写低字节，后写高字节
;   D3-D1 = 011: 方式3 (方波发生器)
;   D0 = 1: BCD计数模式
CTRL_C0_INIT    EQU 00110111B   ; 37H

; Counter 1 控制字 = 0111 0101B = 75H
;   D7-D6 = 01: 选择Counter 1
;   D5-D4 = 11: 读写方式：先写低字节，后写高字节
;   D3-D1 = 010: 方式2 (速率发生器)
;   D0 = 1: BCD计数模式
CTRL_C1_INIT    EQU 01110101B   ; 75H

; 计数初值 (BCD格式)
COUNT_C0_LOW    EQU 00H         ; Counter 0: 1000 (BCD) 的低字节
COUNT_C0_HIGH   EQU 10H         ; Counter 0: 1000 (BCD) 的高字节
COUNT_C1_LOW    EQU 00H         ; Counter 1: 100 (BCD) 的低字节
COUNT_C1_HIGH   EQU 01H         ; Counter 1: 100 (BCD) 的高字节

;============================================================
; 代码段
;============================================================
CODE    SEGMENT PUBLIC 'CODE'
        ASSUME CS:CODE

START:
;------------------------------------------------------------
; 主程序入口
;------------------------------------------------------------

;--------------- 初始化Counter 0 ---------------
INIT_COUNTER0:
        ; 第一步：写入Counter 0的控制字
        MOV DX, PORT_8253_CTRL  ; DX = 216H (控制字寄存器地址)
        MOV AL, CTRL_C0_INIT    ; AL = 37H (Counter 0控制字)
        OUT DX, AL              ; 写入控制字
                                ; Counter 0配置为：方式3, BCD, 先低后高

        ; 第二步：写入Counter 0的计数初值 (1000 BCD)
        MOV DX, PORT_8253_C0    ; DX = 210H (Counter 0地址)
        MOV AL, COUNT_C0_LOW    ; AL = 00H (计数初值低字节)
        OUT DX, AL              ; 先写低字节
        MOV AL, COUNT_C0_HIGH   ; AL = 10H (计数初值高字节)
        OUT DX, AL              ; 后写高字节
                                ; Counter 0开始工作: 1MHz ÷ 1000 = 1kHz

;--------------- 初始化Counter 1 ---------------
INIT_COUNTER1:
        ; 第一步：写入Counter 1的控制字
        MOV DX, PORT_8253_CTRL  ; DX = 216H (控制字寄存器地址)
        MOV AL, CTRL_C1_INIT    ; AL = 75H (Counter 1控制字)
        OUT DX, AL              ; 写入控制字
                                ; Counter 1配置为：方式2, BCD, 先低后高

        ; 第二步：写入Counter 1的计数初值 (100 BCD)
        MOV DX, PORT_8253_C1    ; DX = 212H (Counter 1地址)
        MOV AL, COUNT_C1_LOW    ; AL = 00H (计数初值低字节)
        OUT DX, AL              ; 先写低字节
        MOV AL, COUNT_C1_HIGH   ; AL = 01H (计数初值高字节)
        OUT DX, AL              ; 后写高字节
                                ; Counter 1开始工作: 1kHz ÷ 100 = 10Hz

;--------------- 无限循环，保持程序运行 ---------------
MAIN_LOOP:
        JMP MAIN_LOOP           ; 无限循环
                                ; 8253已配置完成，硬件自动运行

CODE    ENDS
        END START
```

---

#### 实验二代码：LED流水灯定时控制

```assembly
;============================================================
; 8253定时器控制LED流水灯程序 - 8086汇编
;
; 硬件配置:
;   - 8253可编程定时器/计数器芯片 (基址: 210H)
;   - 74LS273锁存器 (端口地址: 200H) 连接8个LED
;   - Counter 0: CLK0输入100kHz，OUT0输出1kHz (作为Counter 2的时钟)
;   - Counter 2: CLK2输入1kHz，OUT2触发NMI中断 (1秒定时)
;
; 功能描述:
;   使用8253定时器产生1秒定时信号
;   通过NMI中断更新LED流水灯显示
;   实现LED从低位到高位循环点亮的效果
;============================================================

;============================================================
; 常量定义
;============================================================

; 8253端口地址
PORT_8253_C0    EQU 210H        ; Counter 0 数据端口
PORT_8253_C1    EQU 212H        ; Counter 1 数据端口 (本程序未使用)
PORT_8253_C2    EQU 214H        ; Counter 2 数据端口
PORT_8253_CTRL  EQU 216H        ; 控制字寄存器

; LED端口地址
PORT_LED        EQU 200H        ; 74LS273锁存器端口地址

; 8253控制字
; Counter 0 控制字 = 0011 0110B = 36H
;   D7-D6 = 00: 选择Counter 0
;   D5-D4 = 11: 读写方式：先写低字节，后写高字节
;   D3-D1 = 011: 方式3 (方波发生器)
;   D0 = 0: 二进制计数模式
CTRL_C0_INIT    EQU 00110110B   ; 36H

; Counter 2 控制字 = 1011 0000B = B0H
;   D7-D6 = 10: 选择Counter 2
;   D5-D4 = 11: 读写方式：先写低字节，后写高字节
;   D3-D1 = 000: 方式0 (计数结束中断)
;   D0 = 0: 二进制计数模式
CTRL_C2_INIT    EQU 10110000B   ; B0H

; 计数初值
COUNT_C0_LOW    EQU 64H         ; Counter 0: 100 (十进制) 的低字节
COUNT_C0_HIGH   EQU 00H         ; Counter 0: 100 (十进制) 的高字节
                                ; 100kHz ÷ 100 = 1kHz

COUNT_C2_LOW    EQU 0E8H        ; Counter 2: 1000 (十进制) 的低字节
COUNT_C2_HIGH   EQU 03H         ; Counter 2: 1000 (十进制) 的高字节
                                ; 1kHz ÷ 1000 = 1Hz (1秒定时)

; LED初始状态
LED_INIT        EQU 0FEH        ; 1111 1110, LED0点亮

;============================================================
; 数据段
;============================================================
DATA    SEGMENT PUBLIC 'DATA'
        ; LED显示状态变量 (存储当前LED的亮灯状态)
        LED_STATUS  DB  LED_INIT
DATA    ENDS

;============================================================
; 代码段
;============================================================
CODE    SEGMENT PUBLIC 'CODE'
        ASSUME CS:CODE, DS:DATA

START:
;------------------------------------------------------------
; 主程序入口
;------------------------------------------------------------

;--------------- 初始化数据段寄存器 ---------------
        MOV AX, DATA
        MOV DS, AX

;--------------- 设置NMI中断向量 ---------------
SETUP_NMI_VECTOR:
        ; NMI中断向量位于内存地址 0000:0008H
        ; 需要将中断服务程序地址 (NMI_ISR) 写入中断向量表

        PUSH DS                 ; 保存DS
        MOV AX, 0000H           ; ES = 0000H (中断向量表段地址)
        MOV ES, AX

        ; 写入偏移地址 (IP)
        MOV BX, 0008H           ; NMI中断向量偏移地址
        MOV WORD PTR ES:[BX], OFFSET NMI_ISR

        ; 写入段地址 (CS)
        MOV WORD PTR ES:[BX+2], CS

        POP DS                  ; 恢复DS

;--------------- 初始化Counter 0 (产生1kHz时基) ---------------
INIT_COUNTER0:
        ; 第一步：写入Counter 0的控制字
        MOV DX, PORT_8253_CTRL  ; DX = 216H
        MOV AL, CTRL_C0_INIT    ; AL = 36H
        OUT DX, AL              ; 写入控制字

        ; 第二步：写入Counter 0的计数初值 (100)
        MOV DX, PORT_8253_C0    ; DX = 210H
        MOV AL, COUNT_C0_LOW    ; AL = 64H (100的低字节)
        OUT DX, AL              ; 先写低字节
        MOV AL, COUNT_C0_HIGH   ; AL = 00H (100的高字节)
        OUT DX, AL              ; 后写高字节
                                ; Counter 0开始工作: 100kHz ÷ 100 = 1kHz

;--------------- 初始化Counter 2 (产生1秒定时) ---------------
INIT_COUNTER2:
        ; 第一步：写入Counter 2的控制字
        MOV DX, PORT_8253_CTRL  ; DX = 216H
        MOV AL, CTRL_C2_INIT    ; AL = B0H
        OUT DX, AL              ; 写入控制字

        ; 第二步：写入Counter 2的计数初值 (1000)
        MOV DX, PORT_8253_C2    ; DX = 214H
        MOV AL, COUNT_C2_LOW    ; AL = E8H (1000的低字节)
        OUT DX, AL              ; 先写低字节
        MOV AL, COUNT_C2_HIGH   ; AL = 03H (1000的高字节)
        OUT DX, AL              ; 后写高字节
                                ; Counter 2开始工作: 1kHz ÷ 1000 = 1Hz
                                ; 1秒后OUT2输出负脉冲，触发NMI中断

;--------------- 初始化LED状态 ---------------
INIT_LED:
        MOV DX, PORT_LED        ; DX = 200H
        MOV AL, LED_STATUS      ; AL = 0FEH (LED0点亮)
        OUT DX, AL              ; 输出到LED端口

;--------------- 开启中断 ---------------
        STI                     ; 开中断 (虽然NMI不受IF标志影响)

;--------------- 主循环 (等待中断) ---------------
MAIN_LOOP:
        HLT                     ; 暂停CPU，等待中断
        JMP MAIN_LOOP           ; 中断返回后继续循环

;============================================================
;           NMI中断服务程序
;============================================================
; 功能: 每1秒触发一次，更新LED流水灯显示
;============================================================
NMI_ISR PROC NEAR
        ; --- 保存现场 ---
        PUSH AX
        PUSH DX

        ; --- 更新LED状态 (循环左移) ---
        MOV AL, LED_STATUS      ; AL = 当前LED状态
        ROL AL, 1               ; 循环左移1位
                                ; 例如: 11111110 → 11111101 (LED1点亮)
        MOV LED_STATUS, AL      ; 保存新状态

        ; --- 输出到LED端口 ---
        MOV DX, PORT_LED        ; DX = 200H
        OUT DX, AL              ; 更新LED显示

        ; --- 重新装载Counter 2计数初值 (方式0需要手动重装) ---
        MOV DX, PORT_8253_C2    ; DX = 214H
        MOV AL, COUNT_C2_LOW    ; AL = E8H (1000的低字节)
        OUT DX, AL              ; 先写低字节
        MOV AL, COUNT_C2_HIGH   ; AL = 03H (1000的高字节)
        OUT DX, AL              ; 后写高字节
                                ; 重新开始1秒计数

        ; --- 恢复现场 ---
        POP DX
        POP AX

        ; --- 中断返回 ---
        IRET                    ; 中断返回指令
NMI_ISR ENDP

CODE    ENDS
        END START
```

---

### 五、实验结果与数据记录

#### 实验一：8253级联分频

**测试记录：**

| 计数器 | 工作方式 | 计数模式 | 计数初值 | 输入频率 | 输出频率 | 分频比 |
|--------|---------|---------|---------|---------|---------|--------|
| Counter 0 | 方式3（方波） | BCD | 1000 | 1 MHz | 1 kHz | 1000 |
| Counter 1 | 方式2（速率） | BCD | 100 | 1 kHz | 10 Hz | 100 |
| **总分频比** | - | - | - | **1 MHz** | **10 Hz** | **100,000** |

**控制字设置：**

| 计数器 | 控制字（二进制） | 控制字（十六进制） | 说明 |
|--------|-----------------|-------------------|------|
| Counter 0 | 0011 0111 | 37H | SC=00, RW=11, M=011, BCD=1 |
| Counter 1 | 0111 0101 | 75H | SC=01, RW=11, M=010, BCD=1 |

**计数初值写入顺序：**

| 步骤 | 端口地址 | 写入数据 | 说明 |
|------|---------|---------|------|
| 1 | 216H | 37H | 写入Counter 0控制字 |
| 2 | 210H | 00H | 写入Counter 0计数初值低字节 (1000 BCD) |
| 3 | 210H | 10H | 写入Counter 0计数初值高字节 |
| 4 | 216H | 75H | 写入Counter 1控制字 |
| 5 | 212H | 00H | 写入Counter 1计数初值低字节 (100 BCD) |
| 6 | 212H | 01H | 写入Counter 1计数初值高字节 |

---

#### 实验二：LED流水灯定时控制

**初始状态：**

| 项目 | 数值/状态 | 说明 |
|------|----------|------|
| Counter 0输入频率 | 100 kHz | CLK0时钟频率 |
| Counter 0计数初值 | 100 (十进制) | 0064H |
| Counter 0输出频率 | 1 kHz | OUT0 = 100kHz ÷ 100 |
| Counter 2输入频率 | 1 kHz | CLK2连接OUT0 |
| Counter 2计数初值 | 1000 (十进制) | 03E8H |
| Counter 2定时周期 | 1 秒 | 1kHz ÷ 1000 = 1Hz |
| LED初始状态 | 0FEH | LED0点亮 (低电平有效) |

**控制字设置：**

| 计数器 | 控制字（二进制） | 控制字（十六进制） | 说明 |
|--------|-----------------|-------------------|------|
| Counter 0 | 0011 0110 | 36H | SC=00, RW=11, M=011, BCD=0 |
| Counter 2 | 1011 0000 | B0H | SC=10, RW=11, M=000, BCD=0 |

**LED流水灯运行记录：**

| 时间 (秒) | LED_STATUS值 | 二进制表示 | 点亮LED | 说明 |
|----------|-------------|-----------|---------|------|
| 0 | 0FEH | 1111 1110 | LED0 | 初始状态 |
| 1 | 0FDH | 1111 1101 | LED1 | NMI中断后ROL 1次 |
| 2 | 0FBH | 1111 1011 | LED2 | NMI中断后ROL 1次 |
| 3 | 0F7H | 1111 0111 | LED3 | NMI中断后ROL 1次 |
| 4 | 0EFH | 1110 1111 | LED4 | NMI中断后ROL 1次 |
| 5 | 0DFH | 1101 1111 | LED5 | NMI中断后ROL 1次 |
| 6 | 0BFH | 1011 1111 | LED6 | NMI中断后ROL 1次 |
| 7 | 07FH | 0111 1111 | LED7 | NMI中断后ROL 1次 |
| 8 | 0FEH | 1111 1110 | LED0 | 循环回到初始状态 |

**NMI中断向量表设置：**

| 内存地址 | 存储内容 | 说明 |
|---------|---------|------|
| 0000:0008H | OFFSET NMI_ISR | NMI中断服务程序偏移地址 (IP) |
| 0000:000AH | CS | NMI中断服务程序段地址 (CS) |

---

### 六、实验现象与分析

#### 实验一现象：

- Counter 0的OUT0输出1kHz方波信号
- Counter 1的OUT1输出10Hz方波信号
- 两级级联实现100,000分频
- 使用BCD计数方式，计数初值直接对应十进制数值

**原理分析：**

1. **方式3 (方波发生器)**：
   - Counter 0工作在方式3，输出占空比为1:1的方波
   - 计数初值为1000 (BCD)，实现1000分频
   - OUT0输出频率 = 1MHz ÷ 1000 = 1kHz

2. **方式2 (速率发生器)**：
   - Counter 1工作在方式2，自动重新装载计数初值
   - CLK1输入为Counter 0的OUT0 (1kHz)
   - 计数初值为100 (BCD)，实现100分频
   - OUT1输出频率 = 1kHz ÷ 100 = 10Hz

3. **BCD计数模式**：
   - 计数值以BCD码形式存储
   - 1000 (BCD) = 1000H (高字节10H，低字节00H)
   - 100 (BCD) = 0100H (高字节01H，低字节00H)

---

#### 实验二现象：

- LED从LED0到LED7依次点亮，每个LED点亮1秒
- LED循环流动，实现流水灯效果
- 定时准确，无明显延迟或抖动
- 中断响应及时，LED切换平滑

**原理分析：**

1. **两级定时器级联**：
   - Counter 0产生1kHz时基信号 (100kHz ÷ 100)
   - Counter 2使用1kHz作为时钟，产生1秒定时 (1kHz ÷ 1000)

2. **NMI中断机制**：
   - Counter 2工作在方式0 (计数结束中断)
   - 计数到0时，OUT2输出负脉冲，触发NMI中断
   - NMI不受IF标志控制，响应优先级最高

3. **中断服务程序流程**：
   - 保存现场 (PUSH AX, DX)
   - 读取LED_STATUS，执行ROL循环左移
   - 输出新状态到LED端口
   - 重新装载Counter 2计数初值 (方式0不自动重装)
   - 恢复现场并返回 (IRET)

4. **LED循环移位**：
   - 使用ROL指令实现循环左移
   - 初始值0FEH (11111110)，LED0点亮
   - 每次ROL后，点亮位向左移动一位
   - 8次移位后自动回到初始状态

---

**成绩：**

**批阅教师：** ————————

**日    期：** ————————
