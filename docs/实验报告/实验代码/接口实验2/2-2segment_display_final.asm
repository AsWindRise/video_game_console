;============================================================
; 八位数码管动态扫描显示程序 - 8086汇编
;
; 硬件配置:
;   - 8255可编程并行接口芯片 (基址: 200H)
;   - PA口: 连接数码管段选信号 (a-g + dp)
;   - PB口: 连接数码管位选信号 (8位,控制哪个数码管亮)
;   - PC口: 连接按键输入
;   - 8个共阴极七段数码管
;
; 功能描述:
;   1. 动态扫描显示数字0-7
;   2. 按下按键后,显示内容循环左移
;      例如: 01234567 → 12345670 → 23456701 → ...
;
; 作者: [你的姓名]
; 日期: [日期]
;============================================================

;============================================================
;               七段数码管基础知识
;============================================================
;
; 【共阴极数码管原理】
;   共阴极: 所有LED的阴极(负极)连在一起接地
;   要点亮某一段,需要在对应引脚输出高电平(1)
;
; 【数码管段选】
;   数码管有7段(a-g)加1个小数点(dp),共8个LED
;   每一位对应一个段:
;
;        aaaa
;       f    b
;       f    b
;        gggg
;       e    c
;       e    c
;        dddd   dp
;
;   段选字节: dp g f e d c b a (从高位到低位)
;
; 【数码管位选】
;   8个数码管,位选信号决定哪个数码管工作
;   位选为0时对应的数码管被选中(低电平有效)
;
; 【动态扫描原理】
;   人眼有视觉暂留效应(约1/24秒)
;   快速轮流点亮每个数码管,人眼看起来就是同时亮的
;   扫描频率要足够快,否则会有闪烁感
;
;============================================================

;============================================================
;               数码管段选码表
;============================================================
;
;   数字    显示段      段选码(dp g f e d c b a)
;   ────────────────────────────────────────────
;    0      a b c d e f     0011 1111 = 3FH
;    1      b c             0000 0110 = 06H
;    2      a b d e g       0101 1011 = 5BH
;    3      a b c d g       0100 1111 = 4FH
;    4      b c f g         0110 0110 = 66H
;    5      a c d f g       0110 1101 = 6DH
;    6      a c d e f g     0111 1101 = 7DH
;    7      a b c           0000 0111 = 07H
;
;============================================================

.MODEL SMALL
.8086
.STACK 256

;============================================================
; 数据段
;============================================================
.DATA

; 数码管段选码表 (共阴极)
; 存储顺序: 数字7,6,5,4,3,2,1,0 (从右到左显示)
; 注意: 数组顺序与显示位置的对应关系
BUF DB 007H     ; 数字7的段选码: 0000 0111
    DB 07DH     ; 数字6的段选码: 0111 1101
    DB 06DH     ; 数字5的段选码: 0110 1101
    DB 066H     ; 数字4的段选码: 0110 0110
    DB 04FH     ; 数字3的段选码: 0100 1111
    DB 05BH     ; 数字2的段选码: 0101 1011
    DB 006H     ; 数字1的段选码: 0000 0110
    DB 03FH     ; 数字0的段选码: 0011 1111

;============================================================
; 常量定义
;============================================================

; 8255端口地址
PORT_8255_PA    EQU 200H        ; PA口 - 段选输出
PORT_8255_PB    EQU 202H        ; PB口 - 位选输出
PORT_8255_PC    EQU 204H        ; PC口 - 按键输入
PORT_8255_CTRL  EQU 206H        ; 控制字寄存器

; 8255控制字
; 控制字 = 1000 1001B = 89H
;   D7 = 1: 方式选择控制字
;   D6-D5 = 00: A组方式0
;   D4 = 0: PA口输出 (段选)
;   D3 = 0: PC高4位输出
;   D2 = 0: B组方式0
;   D1 = 0: PB口输出 (位选)
;   D0 = 1: PC低4位输入 (按键)
CTRL_8255_INIT  EQU 10001001B   ; 89H

; 显示参数
DIGIT_COUNT     EQU 8           ; 数码管数量
DELAY_COUNT     EQU 66H         ; 延时计数值 (控制扫描速度)

; 位选初始值
; 0111 1111 = 7FH,最高位为0,选中最左边的数码管
BIT_SELECT_INIT EQU 7FH

; 按键检测值
; 0xFE = 1111 1110,表示PC0按键被按下
KEY_PRESSED     EQU 0FEH

;============================================================
; 代码段
;============================================================
.CODE
.STARTUP

;------------------------------------------------------------
; 主程序入口
;------------------------------------------------------------
START:

;--------------- 初始化8255 ---------------
; 配置: PA输出(段选), PB输出(位选), PC低4位输入(按键)
INIT_8255:
        MOV DX, PORT_8255_CTRL  ; 控制字寄存器地址
        MOV AL, CTRL_8255_INIT  ; 控制字89H
        OUT DX, AL              ; 写入控制字,完成8255初始化

;============================================================
;               主循环 - 动态扫描显示
;============================================================
MAIN_LOOP:
        MOV CX, DIGIT_COUNT     ; CX = 8,循环8次扫描8个数码管
        MOV AH, BIT_SELECT_INIT ; AH = 7FH = 0111 1111
                                ; 位选信号,最高位为0表示选中第1个数码管
        MOV BX, OFFSET BUF      ; BX指向段选码数组首地址

;--------------- 扫描循环 - 逐个点亮数码管 ---------------
SCAN_LOOP:
        ; 步骤1: 输出位选信号,选中当前数码管
        MOV DX, PORT_8255_PB    ; PB口地址
        MOV AL, AH              ; AL = 当前位选值
        OUT DX, AL              ; 输出位选,选中对应的数码管
                                ; 位选为0的那一位对应的数码管被选中

        ; 步骤2: 输出段选信号,显示对应数字
        MOV DX, PORT_8255_PA    ; PA口地址
        MOV AL, [BX]            ; AL = 当前数字的段选码
        OUT DX, AL              ; 输出段选,点亮对应的段

        ; 步骤3: 延时,让当前数码管保持显示一段时间
        ; 延时时间决定了亮度和扫描频率
        MOV DX, CX              ; 保存CX (因为LOOP要用CX)
        MOV CX, DELAY_COUNT     ; 设置延时循环次数
DELAY_LOOP:
        LOOP DELAY_LOOP         ; 空循环延时
        MOV CX, DX              ; 恢复CX

        ; 步骤4: 准备扫描下一个数码管
        INC BX                  ; BX指向下一个段选码
        ROR AH, 1               ; 位选右移一位
                                ; 0111 1111 → 1011 1111 → 1101 1111 → ...
                                ; 依次选中从左到右的数码管

        LOOP SCAN_LOOP          ; CX减1,继续扫描下一个数码管
                                ; 直到8个数码管都扫描完毕

;--------------- 按键检测 ---------------
; 一轮扫描完成后检测按键状态
CHECK_KEY:
        MOV DX, PORT_8255_PC    ; PC口地址
        IN AL, DX               ; 读取按键状态
        CMP AL, KEY_PRESSED     ; 比较是否等于0xFE (按键按下)
        JZ KEY_DEBOUNCE         ; 相等则跳转到消抖处理
        JMP MAIN_LOOP           ; 没按下,继续扫描显示

;--------------- 按键消抖处理 ---------------
; 等待按键释放,避免一次按键触发多次
KEY_DEBOUNCE:
        MOV DX, PORT_8255_PC    ; PC口地址
        IN AL, DX               ; 读取按键状态
        CMP AL, KEY_PRESSED     ; 判断按键是否仍然按下
        JZ KEY_DEBOUNCE         ; 还在按着就继续等待
                                ; 直到按键释放才继续执行

;============================================================
;           数据左移处理 - 循环移位显示内容
;============================================================
; 功能: 将BUF数组内容循环左移一位
; 效果: 01234567 → 12345670 → 23456701 → ...
;
; 算法:
;   1. 保存第一个元素
;   2. 将后面的元素依次前移
;   3. 把保存的第一个元素放到最后
;
SHIFT_LEFT:
        MOV BX, OFFSET BUF      ; BX指向数组首地址
        MOV CX, 7               ; 循环7次 (移动7个元素)
        MOV AL, [BX]            ; 保存第一个元素到AL

SHIFT_LOOP:
        MOV AH, [BX+1]          ; 取下一个元素
        MOV [BX], AH            ; 放到当前位置 (前移)
        INC BX                  ; 指针后移
        LOOP SHIFT_LOOP         ; 循环直到移完7个

        MOV [BX], AL            ; 把保存的第一个元素放到最后
                                ; 完成循环左移

        JMP MAIN_LOOP           ; 返回主循环,继续扫描显示

;============================================================
; 程序结束 (实际上不会执行到这里,因为是无限循环)
;============================================================
EXIT:
        MOV AX, 4C00H
        INT 21H

        END START

;============================================================
;                      程序流程图
;============================================================
;
;   ┌──────────────────┐
;   │    程序开始      │
;   └────────┬─────────┘
;            ↓
;   ┌──────────────────┐
;   │  初始化8255      │
;   └────────┬─────────┘
;            ↓
;   ┌──────────────────┐
;   │ 设置扫描参数     │←─────────────────────┐
;   │ CX=8, AH=7FH     │                      │
;   └────────┬─────────┘                      │
;            ↓                                │
;   ┌──────────────────┐                      │
;   │ 输出位选(选数码管)│←────┐               │
;   └────────┬─────────┘     │               │
;            ↓               │               │
;   ┌──────────────────┐     │               │
;   │ 输出段选(显示数字)│     │               │
;   └────────┬─────────┘     │               │
;            ↓               │               │
;   ┌──────────────────┐     │               │
;   │    延时          │     │               │
;   └────────┬─────────┘     │               │
;            ↓               │               │
;   ┌──────────────────┐     │               │
;   │  下一个数码管    │     │               │
;   │  BX++, AH右移    │     │               │
;   └────────┬─────────┘     │               │
;            ↓               │               │
;        ┌───┴───┐           │               │
;        │CX=0?  │──否──────→┘               │
;        └───┬───┘                           │
;            │是                             │
;            ↓                               │
;   ┌──────────────────┐                     │
;   │  检测按键        │                     │
;   └────────┬─────────┘                     │
;            ↓                               │
;        ┌───┴───┐                           │
;        │按下?  │──否──────────────────────→┘
;        └───┬───┘
;            │是
;            ↓
;   ┌──────────────────┐
;   │  等待按键释放    │
;   └────────┬─────────┘
;            ↓
;   ┌──────────────────┐
;   │  数据循环左移    │
;   └────────┬─────────┘
;            │
;            └────────────────────────────────┘
;
;============================================================
