;============================================================
; 流水灯控制系统 - 8086汇编程序
;
; 硬件配置:
;   - 8255可编程并行接口 (基址: 200H)
;   - 8253可编程定时器 (基址: 400H)
;   - 8个LED连接至8255 PA口 (低电平点亮)
;   - 8253计数器2输出(OUT2)连接CPU的NMI引脚
;
; 功能描述:
;   实现8位LED循环流水效果
;   利用8253定时器产生1秒定时中断
;   每次中断LED点亮位置左移一位,循环往复
;
; 工作原理:
;   1. 8253计数器0产生1kHz时基信号(方式3)
;   2. 8253计数器2对时基分频,产生1秒定时(方式0)
;   3. 计数器2输出连接NMI,计数完成触发中断
;   4. 中断服务程序更新LED显示状态
;
; 作者: [你的姓名]
; 日期: [日期]
;============================================================

;============================================================
;                    系统原理详解
;============================================================
;
; 【整体系统框图】
;
;   100kHz时钟 ──→ 8253计数器0 ──→ 8253计数器2 ──→ NMI
;                  (÷100=1kHz)    (÷1000=1Hz)     │
;                                                  ↓
;                                            CPU响应中断
;                                                  │
;                                                  ↓
;                                           中断服务程序
;                                                  │
;                                                  ↓
;                              8255 PA口 ──→ 8个LED流水显示
;
; 【为什么需要两级分频】
;   假设输入时钟为100kHz,要产生1秒(1Hz)的定时:
;   如果只用一个计数器: 100kHz ÷ 1Hz = 100000
;   但8253是16位计数器,最大只能计数65535(二进制)或9999(BCD)
;   所以需要两级分频:
;     计数器0: 100kHz ÷ 100 = 1kHz
;     计数器2: 1kHz ÷ 1000 = 1Hz (1秒)
;
; 【什么是NMI中断】
;   NMI = Non-Maskable Interrupt (不可屏蔽中断)
;   特点:
;   - 中断类型号固定为2
;   - 不受IF(中断允许标志)影响,无法用CLI指令屏蔽
;   - 优先级很高,通常用于紧急事件(如掉电、硬件故障)
;   - 本实验中用于定时中断
;
;   中断向量地址计算:
;   向量地址 = 中断类型号 × 4 = 2 × 4 = 8
;   即中断向量存放在 0000:0008H ~ 0000:000BH
;   其中 0008H-0009H 存偏移地址, 000AH-000BH 存段地址
;
; 【中断处理流程】
;
;   1. 8253计数器2计数到0
;          ↓
;   2. OUT2输出低脉冲 → NMI引脚
;          ↓
;   3. CPU完成当前指令后响应中断
;          ↓
;   4. CPU自动完成以下操作:
;      - 将FLAGS压栈
;      - 将CS压栈
;      - 将IP压栈
;      - 从中断向量表取出中断服务程序地址
;      - 跳转到中断服务程序执行
;          ↓
;   5. 执行中断服务程序(更新LED、重装计数器)
;          ↓
;   6. IRET指令返回,恢复FLAGS、CS、IP
;          ↓
;   7. 继续执行被中断的程序
;
;============================================================

;============================================================
;                    8253工作方式详解
;============================================================
;
; 【方式0 - 计数结束中断】
;
;   工作过程:
;   1. 写入控制字后,OUT立即变低
;   2. 写入计数初值后,在下一个CLK下降沿开始计数
;   3. 计数器从初值开始递减: N, N-1, N-2, ..., 1, 0
;   4. 计数到0时,OUT变高,产生中断信号
;   5. 计数器继续递减(FFFF, FFFE, ...),但不再影响OUT
;   6. 若要再次定时,需要重新写入计数初值
;
;   时序图:
;   CLK   ─┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐─
;          └┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘
;   计数值  N  N-1 N-2 ... 2  1  0  FFFF
;   OUT   ──────────────────────┐
;                               └───────
;                               ↑
;                          计数到0,OUT变高
;
; 【方式3 - 方波发生器】
;
;   工作过程:
;   1. 计数值为N时,OUT高N/2个周期,低N/2个周期
;   2. 产生占空比50%的方波
;   3. 自动重装,持续产生方波
;
;   时序图 (N=4):
;   CLK   ─┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐─
;          └┘└┘└┘└┘└┘└┘└┘└┘
;   OUT   ───┐  ┌───┐  ┌───
;            └──┘   └──┘
;          ←2周期→←2周期→
;
;============================================================

;============================================================
; 常量定义
;============================================================

; 8255端口地址
; 8255是并行接口芯片,用于连接LED
PORT_8255_PA    EQU 0200H       ; PA口地址 (连接8个LED)

; 8253端口地址
; 8253是定时/计数器芯片,用于产生定时中断
PORT_8253_CNT0  EQU 0400H       ; 计数器0地址 (A1A0=00)
PORT_8253_CNT2  EQU 0404H       ; 计数器2地址 (A1A0=10)
PORT_8253_CTRL  EQU 0406H       ; 控制字寄存器地址 (A1A0=11)

; 计数器0控制字: 00110111B = 37H
;
;   位7-6 (SC)  = 00: 选择计数器0
;   位5-4 (RW)  = 11: 先读写低字节,后读写高字节
;   位3-1 (M)   = 011: 方式3(方波发生器)
;   位0   (BCD) = 1: BCD码十进制计数
;
;   作用: 将输入的100kHz时钟分频为1kHz方波
;
CTRL_CNT0_MODE3 EQU 00110111B

; 计数器2控制字: 10110001B = B1H
;
;   位7-6 (SC)  = 10: 选择计数器2
;   位5-4 (RW)  = 11: 先读写低字节,后读写高字节
;   位3-1 (M)   = 000: 方式0(计数结束中断)
;   位0   (BCD) = 1: BCD码十进制计数
;
;   作用: 对1kHz信号计数1000次,产生1秒定时
;         计数完成后OUT2输出高电平触发NMI
;
CTRL_CNT2_MODE0 EQU 10110001B

; 计数器0初值: 100 (BCD码)
; 100kHz ÷ 100 = 1kHz
; BCD码100 = 0000 0001 0000 0000
;          = 01H (高字节) + 00H (低字节)
CNT0_INIT_LOW   EQU 00H         ; 低字节: 00
CNT0_INIT_HIGH  EQU 01H         ; 高字节: 01

; 计数器2初值: 1000 (BCD码)
; 1kHz ÷ 1000 = 1Hz (周期1秒)
; BCD码1000 = 0001 0000 0000 0000
;           = 10H (高字节) + 00H (低字节)
CNT2_INIT_LOW   EQU 00H         ; 低字节: 00
CNT2_INIT_HIGH  EQU 10H         ; 高字节: 10

; LED初始状态
; 0FEH = 1111 1110B
; 最低位为0,点亮最右侧的LED (低电平点亮)
LED_INIT_STATE  EQU 0FEH

;============================================================
; 代码段
;============================================================
CODE    SEGMENT PUBLIC 'CODE'
        ASSUME CS:CODE

START:
;------------------------------------------------------------
; 主程序入口
;------------------------------------------------------------

;============================================================
;              初始化NMI中断向量
;============================================================
; 功能: 设置NMI中断的处理程序地址
;
; 中断向量表说明:
;   位于内存最低端 0000:0000 ~ 0000:03FF (共1KB)
;   每个中断向量占4字节: 2字节偏移地址 + 2字节段地址
;   NMI是2号中断,向量地址 = 2 × 4 = 8
;
;   内存布局:
;   0000:0008  中断服务程序偏移地址 (IP)
;   0000:000A  中断服务程序段地址 (CS)
;
INIT_NMI:
        SUB AX, AX              ; AX = 0 (等同于 MOV AX, 0)
        MOV ES, AX              ; ES = 0000H
                                ; ES指向中断向量表所在的段

        ; 设置中断向量的偏移地址部分
        MOV AX, OFFSET NMI_ISR  ; 获取中断服务程序的偏移地址
        MOV ES:[008H], AX       ; 存入 0000:0008

        ; 设置中断向量的段地址部分
        MOV AX, SEG NMI_ISR     ; 获取中断服务程序的段地址
        MOV ES:[00AH], AX       ; 存入 0000:000A
                                ; 至此,NMI中断向量设置完成
                                ; 当NMI发生时,CPU会跳转到NMI_ISR执行

;============================================================
;              初始化8253计数器0 - 时基发生器
;============================================================
; 功能: 产生1kHz方波作为计数器2的时钟源
; 计算: 假设输入时钟100kHz, 100kHz ÷ 100 = 1kHz
;
INIT_CNT0:
        ; 步骤1: 写入控制字
        MOV DX, PORT_8253_CTRL  ; DX = 406H (控制字寄存器)
        MOV AL, CTRL_CNT0_MODE3 ; AL = 00110111B
                                ; 计数器0, 16位, 方式3, BCD
        OUT DX, AL              ; 写入控制字

        ; 步骤2: 写入计数初值 (先低后高)
        MOV DX, PORT_8253_CNT0  ; DX = 400H (计数器0)
        MOV AL, CNT0_INIT_LOW   ; AL = 00H (初值100的低字节)
        OUT DX, AL              ; 写入低字节

        MOV AL, CNT0_INIT_HIGH  ; AL = 01H (初值100的高字节)
        OUT DX, AL              ; 写入高字节
                                ; 计数器0开始工作
                                ; 输出1kHz方波到计数器2的CLK输入

;============================================================
;              初始化8253计数器2 - 定时中断
;============================================================
; 功能: 产生1秒定时,触发NMI中断
; 计算: 1kHz输入, 计数1000次 = 1秒
;
INIT_CNT2:
        ; 步骤1: 写入控制字
        MOV DX, PORT_8253_CTRL  ; DX = 406H (控制字寄存器)
        MOV AL, CTRL_CNT2_MODE0 ; AL = 10110001B
                                ; 计数器2, 16位, 方式0, BCD
        OUT DX, AL              ; 写入控制字

        ; 步骤2: 写入计数初值
        MOV DX, PORT_8253_CNT2  ; DX = 404H (计数器2)
        MOV AL, CNT2_INIT_LOW   ; AL = 00H (初值1000的低字节)
        OUT DX, AL              ; 写入低字节

        MOV AL, CNT2_INIT_HIGH  ; AL = 10H (初值1000的高字节)
        OUT DX, AL              ; 写入高字节
                                ; 计数器2开始计数
                                ; 1秒后OUT2变高,触发NMI

;============================================================
;              初始化LED显示
;============================================================
; 功能: 设置LED初始状态,点亮最右侧LED
;
INIT_LED:
        MOV BL, LED_INIT_STATE  ; BL = 0FEH = 11111110B
                                ; BL用于保存当前LED状态
                                ; 选择BL是因为它在中断中不易被破坏

        MOV DX, PORT_8255_PA    ; DX = 200H (8255 PA口)
        MOV AL, BL              ; AL = LED状态
        OUT DX, AL              ; 输出到PA口,点亮LED0

;============================================================
;              主循环 - 等待中断
;============================================================
; 程序在此处无限循环等待
; 所有工作都由NMI中断服务程序完成
;
MAIN_LOOP:
        JMP MAIN_LOOP           ; 原地死循环
                                ; CPU在此等待NMI中断
                                ; 每秒产生一次中断
                                ; 中断处理完后返回这里继续等待

;============================================================
;              NMI中断服务程序
;============================================================
; 功能:
;   1. 更新LED流水显示(循环左移)
;   2. 重新装载计数器2,准备下一次定时
;
; 触发条件: 8253计数器2计数到0时,OUT2变高触发NMI
;
; 执行频率: 每秒执行1次
;
NMI_ISR:
        ;----- 更新LED状态 -----
        ROL BL, 1               ; BL循环左移1位
                                ; ROL = Rotate Left (循环左移)
                                ; 最高位移出后填入最低位
                                ;
                                ; 状态变化示例:
                                ; 1111 1110 (LED0亮)
                                ;     ↓ ROL
                                ; 1111 1101 (LED1亮)
                                ;     ↓ ROL
                                ; 1111 1011 (LED2亮)
                                ;     ↓ ROL
                                ; ... 依次类推 ...
                                ;     ↓ ROL
                                ; 0111 1111 (LED7亮)
                                ;     ↓ ROL
                                ; 1111 1110 (回到LED0亮)

        MOV AL, BL              ; 将新状态复制到AL
        MOV DX, PORT_8255_PA    ; DX = 200H
        OUT DX, AL              ; 输出到8255 PA口
                                ; LED显示更新

        ;----- 重装计数器2 -----
        ; 方式0不会自动重装,必须手动写入新的计数值
        ; 否则计数器2不会再次触发中断
        MOV DX, PORT_8253_CNT2  ; DX = 404H
        MOV AL, CNT2_INIT_LOW   ; AL = 00H
        OUT DX, AL              ; 写入低字节

        MOV AL, CNT2_INIT_HIGH  ; AL = 10H
        OUT DX, AL              ; 写入高字节
                                ; 计数器2重新开始计数
                                ; 1秒后将再次触发NMI

        IRET                    ; 中断返回指令
                                ; Interrupt Return
                                ; 自动从栈中恢复IP、CS、FLAGS
                                ; 返回到被中断的位置继续执行

CODE    ENDS
        END START

;============================================================
;                    程序执行流程
;============================================================
;
;   ┌─────────────────────────────────┐
;   │         程序开始                │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 1. 初始化NMI中断向量            │
;   │    设置中断服务程序地址         │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 2. 初始化8253计数器0            │
;   │    方式3,产生1kHz方波           │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 3. 初始化8253计数器2            │
;   │    方式0,1秒后触发中断          │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 4. 初始化LED,点亮LED0           │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 5. 主循环: JMP MAIN_LOOP        │←──────┐
;   │    (等待中断)                   │       │
;   └───────────────┬─────────────────┘       │
;                   ↓ (每秒1次NMI中断)        │
;   ┌─────────────────────────────────┐       │
;   │ 6. 中断服务程序NMI_ISR          │       │
;   │    · ROL BL,1 LED状态左移       │       │
;   │    · 输出新状态到PA口           │       │
;   │    · 重装计数器2                │       │
;   │    · IRET返回                   │───────┘
;   └─────────────────────────────────┘
;
;============================================================
;                  LED状态变化示意
;============================================================
;
;   时间(秒)   BL值      LED状态(●=亮,○=灭)
;   ──────────────────────────────────────────
;   0         FEH       ○○○○ ○○○●  (LED0)
;   1         FDH       ○○○○ ○○●○  (LED1)
;   2         FBH       ○○○○ ○●○○  (LED2)
;   3         F7H       ○○○○ ●○○○  (LED3)
;   4         EFH       ○○○● ○○○○  (LED4)
;   5         DFH       ○○●○ ○○○○  (LED5)
;   6         BFH       ○●○○ ○○○○  (LED6)
;   7         7FH       ●○○○ ○○○○  (LED7)
;   8         FEH       ○○○○ ○○○●  (LED0,循环)
;   ...
;
;============================================================
;                    硬件连接示意图
;============================================================
;
;   ┌─────────────────────────────────────────────────┐
;   │                    CPU 8086                     │
;   │                                                 │
;   │   NMI ←────────────────────────────┐            │
;   └─────────────────────────────────────│───────────┘
;                                         │
;   ┌─────────────────────────────────────│───────────┐
;   │              8253定时器              │           │
;   │                                     │           │
;   │  100kHz ──→ [计数器0] ──→ [计数器2] ──→ OUT2    │
;   │              方式3         方式0              │
;   │              ÷100          ÷1000             │
;   │              =1kHz         =1Hz              │
;   └─────────────────────────────────────────────────┘
;
;   ┌─────────────────────────────────────────────────┐
;   │              8255并行接口                        │
;   │                                                 │
;   │   PA0 ──→ LED0 ●                               │
;   │   PA1 ──→ LED1 ○                               │
;   │   PA2 ──→ LED2 ○                               │
;   │   PA3 ──→ LED3 ○                               │
;   │   PA4 ──→ LED4 ○                               │
;   │   PA5 ──→ LED5 ○                               │
;   │   PA6 ──→ LED6 ○                               │
;   │   PA7 ──→ LED7 ○                               │
;   └─────────────────────────────────────────────────┘
;
;============================================================
