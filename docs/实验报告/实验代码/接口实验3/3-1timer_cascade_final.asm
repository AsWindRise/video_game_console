;============================================================
; 8253定时器级联分频程序 - 8086汇编
;
; 硬件配置:
;   - 8253可编程定时/计数器 (基址: 400H)
;   - 计数器0输出(OUT0)连接计数器1输入(CLK1)
;
; 功能描述:
;   通过两个计数器级联实现大分频比
;   计数器0: 对输入时钟进行1000分频
;   计数器1: 对计数器0输出再进行100分频
;   总分频比: 1000 × 100 = 100000
;
; 应用场景:
;   假设输入时钟为1MHz
;   计数器0输出: 1MHz ÷ 1000 = 1kHz
;   计数器1输出: 1kHz ÷ 100 = 10Hz
;
; 作者: [你的姓名]
; 日期: [日期]
;============================================================

;============================================================
;                    8253芯片基础知识
;============================================================
;
; 【什么是8253】
;   8253是可编程定时/计数器芯片
;   内部有3个独立的16位计数器(计数器0、1、2)
;   每个计数器可以独立编程,设置不同的工作方式
;   常用于产生精确的时间延迟、定时中断、波形发生等
;
; 【8253内部结构】
;
;   ┌────────────────────────────────────────┐
;   │               8253芯片                 │
;   │  ┌──────────┐  ┌──────────┐  ┌──────────┐
;   │  │ 计数器0  │  │ 计数器1  │  │ 计数器2  │
;   │  │          │  │          │  │          │
;   │  │ CLK0→   │  │ CLK1→   │  │ CLK2→   │
;   │  │ GATE0→  │  │ GATE1→  │  │ GATE2→  │
;   │  │    →OUT0│  │    →OUT1│  │    →OUT2│
;   │  └──────────┘  └──────────┘  └──────────┘
;   │                                        │
;   │            控制字寄存器                │
;   └────────────────────────────────────────┘
;
;   CLK:  时钟输入,计数器在每个CLK下降沿减1
;   GATE: 门控信号,控制计数器是否工作
;   OUT:  输出信号,根据工作方式产生不同波形
;
; 【8253端口地址】
;   8253有4个端口地址,由A1、A0两根地址线选择:
;
;   A1  A0  选择的端口
;   ─────────────────────
;   0   0   计数器0
;   0   1   计数器1
;   1   0   计数器2
;   1   1   控制字寄存器
;
;   本实验基地址为400H:
;   计数器0: 400H (A1A0=00)
;   计数器1: 402H (A1A0=01)
;   计数器2: 404H (A1A0=10)
;   控制字:  406H (A1A0=11)
;
; 【8253控制字格式】
;   控制字是8位,用于配置计数器的工作方式:
;
;   D7  D6  D5  D4  D3  D2  D1  D0
;   ─────────────────────────────────
;   SC1 SC0 RW1 RW0 M2  M1  M0  BCD
;
;   SC1-SC0: 选择计数器 (Select Counter)
;     00 = 计数器0
;     01 = 计数器1
;     10 = 计数器2
;     11 = 非法
;
;   RW1-RW0: 读写方式 (Read/Write)
;     00 = 锁存当前计数值
;     01 = 只读写低8位
;     10 = 只读写高8位
;     11 = 先读写低8位,再读写高8位
;
;   M2-M1-M0: 工作方式 (Mode)
;     000 = 方式0: 计数结束中断
;     001 = 方式1: 可重触发单稳
;     X10 = 方式2: 分频器(速率发生器)
;     X11 = 方式3: 方波发生器
;     100 = 方式4: 软件触发选通
;     101 = 方式5: 硬件触发选通
;
;   BCD: 计数方式
;     0 = 二进制计数 (0000-FFFF)
;     1 = BCD码计数 (0000-9999)
;
; 【方式2和方式3的区别】
;
;   方式2 (分频器/速率发生器):
;     输出一个周期性的负脉冲
;     OUT在计数过程中保持高电平
;     计数到1时OUT变低一个时钟周期,然后恢复高
;     适合产生定时中断信号
;
;     输出波形:
;     ────┐ ┌────────┐ ┌────────┐ ┌────
;         └─┘        └─┘        └─┘
;         ↑          ↑          ↑
;        脉冲       脉冲       脉冲
;
;   方式3 (方波发生器):
;     输出占空比50%的方波
;     计数值为N时,OUT高N/2个周期,低N/2个周期
;     适合产生时钟信号
;
;     输出波形:
;     ────┐    ┌────┐    ┌────┐    ┌──
;         └────┘    └────┘    └────┘
;         高  低    高  低    高  低
;
; 【级联分频原理】
;   将计数器0的输出(OUT0)连接到计数器1的时钟输入(CLK1)
;   实现两级分频,总分频比 = 分频比0 × 分频比1
;
;   输入时钟 ──→ [计数器0] ──→ [计数器1] ──→ 输出
;              (÷1000)      (÷100)
;
;   例如: 1MHz ──→ 1kHz ──→ 10Hz
;
; 【BCD码计数说明】
;   BCD码: 用4位二进制表示1位十进制数
;   例如: 1000(十进制) = 0001 0000 0000 0000(BCD)
;                      = 1    0    0    0
;         高字节=10H,低字节=00H
;
;   100(十进制) = 0000 0001 0000 0000(BCD)
;               = 0    1    0    0
;        高字节=01H,低字节=00H
;
;============================================================

;============================================================
; 常量定义
;============================================================

; 8253端口地址定义
PORT_8253_CNT0  EQU 400H        ; 计数器0端口地址 (A1A0=00)
PORT_8253_CNT1  EQU 402H        ; 计数器1端口地址 (A1A0=01)
PORT_8253_CNT2  EQU 404H        ; 计数器2端口地址 (A1A0=10)
PORT_8253_CTRL  EQU 406H        ; 控制字寄存器地址 (A1A0=11)

; 计数器0控制字: 00110111B = 37H
;
;   位7-6 = 00: 选择计数器0
;   位5-4 = 11: 先写低字节,再写高字节(16位计数)
;   位3-1 = 011: 方式3(方波发生器)
;   位0   = 1: BCD码计数
;
;   二进制分解: 0  0  1  1  0  1  1  1
;              SC1 SC0 RW1 RW0 M2 M1 M0 BCD
;
CTRL_CNT0       EQU 00110111B

; 计数器1控制字: 01110101B = 75H
;
;   位7-6 = 01: 选择计数器1
;   位5-4 = 11: 先写低字节,再写高字节(16位计数)
;   位3-1 = 010: 方式2(分频器)
;   位0   = 1: BCD码计数
;
;   二进制分解: 0  1  1  1  0  1  0  1
;              SC1 SC0 RW1 RW0 M2 M1 M0 BCD
;
CTRL_CNT1       EQU 01110101B

; 计数器0初值: 1000 (BCD码)
; 1000 = 0001 0000 0000 0000 (BCD)
;      = 10H (高字节) + 00H (低字节)
CNT0_INIT_LOW   EQU 00H         ; 低字节: 00
CNT0_INIT_HIGH  EQU 10H         ; 高字节: 10 (表示BCD的1000)

; 计数器1初值: 100 (BCD码)
; 100 = 0000 0001 0000 0000 (BCD)
;     = 01H (高字节) + 00H (低字节)
CNT1_INIT_LOW   EQU 00H         ; 低字节: 00
CNT1_INIT_HIGH  EQU 01H         ; 高字节: 01 (表示BCD的100)

;============================================================
; 代码段
;============================================================
CODE    SEGMENT PUBLIC 'CODE'
        ASSUME CS:CODE

START:
;------------------------------------------------------------
; 主程序入口
;------------------------------------------------------------

;============================================================
;              初始化计数器0 - 方式3方波发生器
;============================================================
; 功能: 对输入时钟进行1000分频,输出方波
; 假设CLK0输入1MHz,则OUT0输出1kHz方波
;
INIT_CNT0:
        ;----- 步骤1: 写入控制字 -----
        MOV DX, PORT_8253_CTRL  ; DX = 406H,指向控制字寄存器
        MOV AL, CTRL_CNT0       ; AL = 00110111B
                                ; 选择计数器0,16位,方式3,BCD
        OUT DX, AL              ; 将控制字写入8253
                                ; 此时计数器0被配置为方式3

        ;----- 步骤2: 写入计数初值 -----
        ; 注意: 必须先写低字节,再写高字节!
        MOV DX, PORT_8253_CNT0  ; DX = 400H,指向计数器0
        MOV AL, CNT0_INIT_LOW   ; AL = 00H,初值1000的低字节
        OUT DX, AL              ; 写入低字节

        MOV AL, CNT0_INIT_HIGH  ; AL = 10H,初值1000的高字节
        OUT DX, AL              ; 写入高字节
                                ; 写完高字节后,计数器0开始工作
                                ; 每1000个输入时钟周期
                                ; OUT0产生一个完整的方波周期

;============================================================
;              初始化计数器1 - 方式2分频器
;============================================================
; 功能: 对计数器0的输出进行100分频
; CLK1来自OUT0(1kHz),则OUT1输出10Hz
;
INIT_CNT1:
        ;----- 步骤1: 写入控制字 -----
        MOV DX, PORT_8253_CTRL  ; DX = 406H,指向控制字寄存器
        MOV AL, CTRL_CNT1       ; AL = 01110101B
                                ; 选择计数器1,16位,方式2,BCD
        OUT DX, AL              ; 将控制字写入8253
                                ; 此时计数器1被配置为方式2

        ;----- 步骤2: 写入计数初值 -----
        MOV DX, PORT_8253_CNT1  ; DX = 402H,指向计数器1
        MOV AL, CNT1_INIT_LOW   ; AL = 00H,初值100的低字节
        OUT DX, AL              ; 写入低字节

        MOV AL, CNT1_INIT_HIGH  ; AL = 01H,初值100的高字节
        OUT DX, AL              ; 写入高字节
                                ; 写完后,计数器1开始工作
                                ; 每100个CLK1周期(即100ms)
                                ; OUT1产生一个负脉冲

;============================================================
;                      程序结束
;============================================================
EXIT:
        MOV AX, 4C00H           ; AH=4CH: DOS程序终止功能
                                ; AL=00H: 返回码0(正常结束)
        INT 21H                 ; 调用DOS中断,结束程序

CODE    ENDS
        END START

;============================================================
;                    程序执行流程
;============================================================
;
;   ┌─────────────────────────────────┐
;   │         程序开始                │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 初始化计数器0                   │
;   │ · 写控制字: 方式3,BCD           │
;   │ · 写初值: 1000                  │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 初始化计数器1                   │
;   │ · 写控制字: 方式2,BCD           │
;   │ · 写初值: 100                   │
;   └───────────────┬─────────────────┘
;                   ↓
;   ┌─────────────────────────────────┐
;   │ 程序结束,返回DOS                │
;   │ (8253继续自动运行)              │
;   └─────────────────────────────────┘
;
;============================================================
;                    级联分频示意图
;============================================================
;
;   输入时钟(1MHz)
;        │
;        ↓ CLK0
;   ┌─────────────┐
;   │   计数器0   │  方式3: 方波发生器
;   │  初值=1000  │  分频比: 1000
;   └──────┬──────┘
;          │ OUT0 (1kHz方波)
;          │
;          ↓ CLK1
;   ┌─────────────┐
;   │   计数器1   │  方式2: 分频器
;   │  初值=100   │  分频比: 100
;   └──────┬──────┘
;          │ OUT1 (10Hz脉冲)
;          ↓
;       输出信号
;
;   总分频比 = 1000 × 100 = 100,000
;   输出频率 = 1MHz ÷ 100,000 = 10Hz
;
;============================================================
;                    时序波形示意
;============================================================
;
;   CLK0 (1MHz输入):
;   ─┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌┐┌─
;    └┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└┘└
;   ←──────────────── 1000个周期 ────────────────→
;
;   OUT0 (1kHz方波):
;   ─────────────────┐                   ┌─────────
;                    └───────────────────┘
;   ←──── 500周期 ────→←──── 500周期 ────→
;   ←────────── 1ms (1kHz) ──────────────→
;
;   OUT1 (10Hz脉冲):
;   ───────────────────────────────────┐ ┌─────────
;                                      └─┘
;   ←────────── 100ms (10Hz) ───────────→
;
;============================================================
