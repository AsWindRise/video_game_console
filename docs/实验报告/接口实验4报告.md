# 实验报告单

**实验名称：** 6. 综合应用实验 - 交通灯控制系统

**实验室：** 产教融合大楼A301/通识机房508
**时间：** 2025.12.4

---

## 实验项目

### 一、实验目的

1. 掌握8255和8253芯片的综合应用方法；
2. 学会多芯片协同工作的系统设计方法；
3. 掌握NMI中断的使用方法和中断向量表的设置；
4. 理解交通灯控制系统的时序设计原理；
5. 掌握标志位轮询方式实现延时的方法；
6. 学会使用子程序模块化设计程序。

---

### 二、系统硬件配置

#### 2.1 端口地址

**8255端口地址（基址200H）：**

| 端口     | 地址  | 功能说明                |
|----------|-------|------------------------|
| PA口     | 200H  | 连接6个交通灯LED        |
| PB口     | 202H  | 未使用                 |
| PC口     | 204H  | 未使用                 |
| 控制字   | 206H  | 控制寄存器             |

**8253端口地址（基址400H）：**

| 端口     | 地址  | 功能说明                |
|----------|-------|------------------------|
| 计数器0  | 400H  | 产生1kHz时基信号        |
| 计数器1  | 402H  | 未使用                 |
| 计数器2  | 404H  | 产生定时中断            |
| 控制字   | 406H  | 控制寄存器             |

#### 2.2 PA口与交通灯连接关系

| PA口位 | 连接设备 | 低电平状态 | 高电平状态 |
|--------|---------|-----------|-----------|
| PA5    | 南北绿灯 | 点亮      | 熄灭      |
| PA4    | 南北黄灯 | 点亮      | 熄灭      |
| PA3    | 南北红灯 | 点亮      | 熄灭      |
| PA2    | 东西绿灯 | 点亮      | 熄灭      |
| PA1    | 东西黄灯 | 点亮      | 熄灭      |
| PA0    | 东西红灯 | 点亮      | 熄灭      |

---

### 三、实验步骤

1. 在Proteus中搭建硬件电路（8086、8255、8253、LED、信号源等）
2. 配置8255：PA口输出模式，控制字80H
3. 配置8253：Counter 0（方式3，÷100，产生1kHz），Counter 2（方式0，定时中断）
4. 设置NMI中断向量表，指向中断服务程序
5. 编写程序：实现四阶段交通灯循环控制
6. 编译并启动仿真，测试交通灯时序

---

### 四、实验代码

```assembly
;============================================================
; 交通灯控制系统 - 8086汇编程序
;
; 硬件配置:
;   - 8255可编程并行接口 (基址: 200H)
;   - 8253可编程定时器 (基址: 400H)
;   - 6个LED模拟交通灯 (连接至8255 PA口)
;   - 8253计数器2输出连接CPU的NMI引脚
;
; 功能描述:
;   实现十字路口交通灯自动控制
;   南北方向与东西方向交替放行,包含黄灯闪烁过渡
;
; 时序设计:
;   南北绿灯(10s) → 南北黄灯闪烁(5s) →
;   东西绿灯(10s) → 东西黄灯闪烁(5s) → 循环
;============================================================

.MODEL SMALL
.8086
.STACK 256

;============================================================
; 常量定义
;============================================================

;--------------------- 8255端口地址 ---------------------
PORT_8255_PA    EQU 200H        ; PA口地址 - 连接6个交通灯LED
PORT_8255_CTRL  EQU 206H        ; 控制字寄存器地址

;--------------------- 8253端口地址 ---------------------
PORT_8253_CNT0  EQU 400H        ; 计数器0地址 (产生1kHz时基)
PORT_8253_CNT2  EQU 404H        ; 计数器2地址 (产生定时中断)
PORT_8253_CTRL  EQU 406H        ; 控制字寄存器地址

;--------------------- 8255控制字 ---------------------
; 10000000B = 80H
;   D7=1: 方式选择控制字
;   D6-D5=00: A组方式0(基本输入输出)
;   D4=0: PA口输出(控制交通灯)
;   D3=0: PC高4位输出
;   D2=0: B组方式0
;   D1=0: PB口输出
;   D0=0: PC低4位输出
CTRL_8255_INIT  EQU 10000000B

;--------------------- 8253控制字 ---------------------
; 计数器0: 方式3方波发生器,产生1kHz时基
; 00110111B:
;   SC=00: 选择计数器0
;   RW=11: 先读写低字节,再读写高字节(16位)
;   M=011: 方式3(方波发生器)
;   BCD=1: BCD码十进制计数
CTRL_CNT0_MODE3 EQU 00110111B

; 计数器2: 方式0计数结束中断,产生定时
; 10110001B:
;   SC=10: 选择计数器2
;   RW=11: 16位读写
;   M=000: 方式0(计数结束中断)
;   BCD=1: BCD码计数
CTRL_CNT2_MODE0 EQU 10110001B

;============================================================
;              交通灯状态编码定义
;============================================================
;
; PA口位定义:
;   PA5 = 南北绿    PA2 = 东西绿
;   PA4 = 南北黄    PA1 = 东西黄
;   PA3 = 南北红    PA0 = 东西红
;
; 低电平(0)点亮,高电平(1)熄灭
;------------------------------------------------------------

; 状态1: 南北绿灯通行,东西红灯等待
; 南北: 绿亮(0) 黄灭(1) 红灭(1) = 011
; 东西: 绿灭(1) 黄灭(1) 红亮(0) = 110
; PA值: 00 011 110 = 1EH
LIGHT_NS_GREEN_EW_RED   EQU 01EH

; 状态2: 南北黄灯警示,东西红灯等待
; 南北: 绿灭(1) 黄亮(0) 红灭(1) = 101
; 东西: 绿灭(1) 黄灭(1) 红亮(0) = 110
; PA值: 00 101 110 = 2EH
LIGHT_NS_YELLOW_EW_RED  EQU 02EH

; 状态3: 南北灯灭(黄灯闪烁的灭状态),东西红灯
; 南北: 绿灭(1) 黄灭(1) 红灭(1) = 111
; 东西: 绿灭(1) 黄灭(1) 红亮(0) = 110
; PA值: 00 111 110 = 3EH
LIGHT_NS_OFF_EW_RED     EQU 03EH

; 状态4: 南北红灯等待,东西绿灯通行
; 南北: 绿灭(1) 黄灭(1) 红亮(0) = 110
; 东西: 绿亮(0) 黄灭(1) 红灭(1) = 011
; PA值: 00 110 011 = 33H
LIGHT_NS_RED_EW_GREEN   EQU 033H

; 状态5: 南北红灯等待,东西黄灯警示
; 南北: 绿灭(1) 黄灭(1) 红亮(0) = 110
; 东西: 绿灭(1) 黄亮(0) 红灭(1) = 101
; PA值: 00 110 101 = 35H
LIGHT_NS_RED_EW_YELLOW  EQU 035H

; 状态6: 南北红灯,东西灯灭(黄灯闪烁的灭状态)
; PA值: 00 110 111 = 37H
LIGHT_NS_RED_EW_OFF     EQU 037H

;--------------------- 定时参数 ---------------------
TIME_GREEN      EQU 10          ; 绿灯持续时间: 10秒
TIME_YELLOW     EQU 5           ; 黄灯闪烁次数: 5次(共5秒)

; 计数器初值 (BCD码)
CNT_1S_LOW      EQU 00H         ; 1000(BCD)的低字节 = 1秒
CNT_1S_HIGH     EQU 10H         ; 1000(BCD)的高字节
CNT_HALF_S_LOW  EQU 00H         ; 500(BCD)的低字节 = 0.5秒
CNT_HALF_S_HIGH EQU 05H         ; 500(BCD)的高字节

;============================================================
; 数据段
;============================================================
.DATA
    ; 延时完成标志
    ; 0 = 正在等待定时完成
    ; 1 = 定时已完成(由NMI中断设置)
    delay_flag  DB 0

;============================================================
; 代码段
;============================================================
.CODE
.STARTUP

;============================================================
;                      主程序
;============================================================
; 功能: 系统初始化后进入交通灯控制主循环
; 流程:
;   1. 初始化各硬件模块
;   2. 循环执行四个阶段的交通灯控制
;============================================================
MAIN PROC
    ;----- 初始化数据段寄存器 -----
    MOV AX, @DATA
    MOV DS, AX

    ;----- 系统初始化 -----
    CALL INIT_NMI               ; 设置NMI中断向量
    CALL INIT_8255              ; 初始化8255并行接口
    CALL INIT_8253_CNT0         ; 初始化8253时基发生器

;============================================================
;              交通灯控制主循环
;============================================================
MAIN_LOOP:

;--------------- 阶段1: 南北绿灯通行 ---------------
    MOV AL, LIGHT_NS_GREEN_EW_RED
    CALL SET_LIGHT
    MOV CX, TIME_GREEN
    CALL DELAY_SECONDS

;--------------- 阶段2: 南北黄灯闪烁 ---------------
    MOV CX, TIME_YELLOW
NS_YELLOW_BLINK:
    PUSH CX

    ; 黄灯亮
    MOV AL, LIGHT_NS_YELLOW_EW_RED
    CALL SET_LIGHT
    CALL DELAY_HALF_SECOND

    ; 黄灯灭
    MOV AL, LIGHT_NS_OFF_EW_RED
    CALL SET_LIGHT
    CALL DELAY_HALF_SECOND

    POP CX
    LOOP NS_YELLOW_BLINK

;--------------- 阶段3: 东西绿灯通行 ---------------
    MOV AL, LIGHT_NS_RED_EW_GREEN
    CALL SET_LIGHT
    MOV CX, TIME_GREEN
    CALL DELAY_SECONDS

;--------------- 阶段4: 东西黄灯闪烁 ---------------
    MOV CX, TIME_YELLOW
EW_YELLOW_BLINK:
    PUSH CX

    ; 黄灯亮
    MOV AL, LIGHT_NS_RED_EW_YELLOW
    CALL SET_LIGHT
    CALL DELAY_HALF_SECOND

    ; 黄灯灭
    MOV AL, LIGHT_NS_RED_EW_OFF
    CALL SET_LIGHT
    CALL DELAY_HALF_SECOND

    POP CX
    LOOP EW_YELLOW_BLINK

    ;----- 返回阶段1,无限循环 -----
    JMP MAIN_LOOP

MAIN ENDP

;============================================================
;              子程序: INIT_NMI
;============================================================
; 功能: 设置NMI(不可屏蔽中断)的中断向量
; NMI中断向量地址: 0000:0008H
;============================================================
INIT_NMI PROC
    PUSH ES
    PUSH AX

    XOR AX, AX
    MOV ES, AX

    ; 设置中断向量的偏移地址
    MOV AX, OFFSET NMI_ISR
    MOV ES:[08H], AX

    ; 设置中断向量的段地址
    MOV AX, SEG NMI_ISR
    MOV ES:[0AH], AX

    POP AX
    POP ES
    RET
INIT_NMI ENDP

;============================================================
;              子程序: INIT_8255
;============================================================
; 功能: 初始化8255可编程并行接口
; 设置: PA口为输出模式,用于驱动交通灯LED
;============================================================
INIT_8255 PROC
    MOV DX, PORT_8255_CTRL
    MOV AL, CTRL_8255_INIT      ; AL = 80H
    OUT DX, AL
    RET
INIT_8255 ENDP

;============================================================
;              子程序: INIT_8253_CNT0
;============================================================
; 功能: 初始化8253计数器0,产生1kHz时基信号
; 配置: 方式3, BCD, 初值100
; 计算: 100kHz ÷ 100 = 1kHz
;============================================================
INIT_8253_CNT0 PROC
    ; 写入控制字
    MOV DX, PORT_8253_CTRL
    MOV AL, CTRL_CNT0_MODE3     ; AL = 37H
    OUT DX, AL

    ; 写入计数初值100(BCD)
    MOV DX, PORT_8253_CNT0
    MOV AL, 00H                 ; 低字节
    OUT DX, AL
    MOV AL, 01H                 ; 高字节
    OUT DX, AL
    RET
INIT_8253_CNT0 ENDP

;============================================================
;              子程序: SET_LIGHT
;============================================================
; 功能: 设置交通灯显示状态
; 入口参数: AL = 灯状态控制字
;============================================================
SET_LIGHT PROC
    PUSH DX
    MOV DX, PORT_8255_PA
    OUT DX, AL
    POP DX
    RET
SET_LIGHT ENDP

;============================================================
;              子程序: DELAY_SECONDS
;============================================================
; 功能: 延时指定秒数
; 入口参数: CX = 延时秒数
; 实现: 配置8253计数器2,通过NMI中断实现定时
;============================================================
DELAY_SECONDS PROC
    PUSH AX
    PUSH DX
    PUSH CX

DELAY_SEC_LOOP:
    PUSH CX

    ;----- 配置计数器2: 方式0,1秒定时 -----
    MOV DX, PORT_8253_CTRL
    MOV AL, CTRL_CNT2_MODE0     ; AL = B1H
    OUT DX, AL

    ;----- 写入计数初值1000(BCD) -----
    MOV DX, PORT_8253_CNT2
    MOV AL, CNT_1S_LOW          ; AL = 00H
    OUT DX, AL
    MOV AL, CNT_1S_HIGH         ; AL = 10H
    OUT DX, AL

    ;----- 等待定时完成 -----
    MOV delay_flag, 0
WAIT_1S:
    CMP delay_flag, 1
    JNE WAIT_1S

    POP CX
    LOOP DELAY_SEC_LOOP

    POP CX
    POP DX
    POP AX
    RET
DELAY_SECONDS ENDP

;============================================================
;              子程序: DELAY_HALF_SECOND
;============================================================
; 功能: 延时0.5秒,用于黄灯闪烁效果
; 实现: 计数器2初值为500(BCD), 1kHz ÷ 500 = 0.5秒
;============================================================
DELAY_HALF_SECOND PROC
    PUSH AX
    PUSH DX

    ;----- 配置计数器2: 方式0,0.5秒定时 -----
    MOV DX, PORT_8253_CTRL
    MOV AL, CTRL_CNT2_MODE0
    OUT DX, AL

    ;----- 写入计数初值500(BCD) -----
    MOV DX, PORT_8253_CNT2
    MOV AL, CNT_HALF_S_LOW      ; AL = 00H
    OUT DX, AL
    MOV AL, CNT_HALF_S_HIGH     ; AL = 05H
    OUT DX, AL

    ;----- 等待定时完成 -----
    MOV delay_flag, 0
WAIT_HALF:
    CMP delay_flag, 1
    JNE WAIT_HALF

    POP DX
    POP AX
    RET
DELAY_HALF_SECOND ENDP

;============================================================
;              中断服务程序: NMI_ISR
;============================================================
; 功能: 处理NMI中断,设置延时完成标志
; 触发: 8253计数器2计数到0时触发
;============================================================
NMI_ISR PROC
    PUSH AX
    PUSH DS

    ;----- 设置数据段 -----
    MOV AX, @DATA
    MOV DS, AX

    ;----- 设置延时完成标志 -----
    MOV delay_flag, 1

    POP DS
    POP AX
    IRET
NMI_ISR ENDP

;============================================================
; 程序结束
;============================================================
END
```

---

### 五、实验结果与数据记录

#### 5.1 交通灯状态编码表

| 状态 | 南北方向 | 东西方向 | PA口值 | 二进制 | 说明 |
|------|---------|---------|--------|--------|------|
| 状态1 | 绿灯亮 | 红灯亮 | 1EH | 00 011 110 | 南北通行 |
| 状态2 | 黄灯亮 | 红灯亮 | 2EH | 00 101 110 | 南北警示 |
| 状态3 | 全灭 | 红灯亮 | 3EH | 00 111 110 | 黄灯闪烁灭状态 |
| 状态4 | 红灯亮 | 绿灯亮 | 33H | 00 110 011 | 东西通行 |
| 状态5 | 红灯亮 | 黄灯亮 | 35H | 00 110 101 | 东西警示 |
| 状态6 | 红灯亮 | 全灭 | 37H | 00 110 111 | 黄灯闪烁灭状态 |

#### 5.2 控制字设置记录

**8255控制字：**

| 控制字 | 二进制 | 十六进制 | 说明 |
|--------|--------|---------|------|
| CTRL_8255_INIT | 1000 0000 | 80H | PA/PB/PC全部输出 |

**8253控制字：**

| 计数器 | 控制字（二进制） | 控制字（十六进制） | 说明 |
|--------|-----------------|-------------------|------|
| Counter 0 | 0011 0111 | 37H | SC=00, RW=11, M=011, BCD=1 |
| Counter 2 | 1011 0001 | B1H | SC=10, RW=11, M=000, BCD=1 |

#### 5.3 定时参数设置

| 计数器 | 工作方式 | 输入频率 | 计数初值 | 输出/定时 | 用途 |
|--------|---------|---------|---------|----------|------|
| Counter 0 | 方式3（方波） | 100 kHz | 100 (BCD) | 1 kHz方波 | 时基信号 |
| Counter 2 | 方式0（中断） | 1 kHz | 1000 (BCD) | 1秒定时 | 绿灯延时 |
| Counter 2 | 方式0（中断） | 1 kHz | 500 (BCD) | 0.5秒定时 | 黄灯闪烁 |

#### 5.4 交通灯运行时序表

| 时间段 | 阶段 | 南北方向 | 东西方向 | PA口值 | 持续时间 |
|--------|------|---------|---------|--------|---------|
| 0-10秒 | 阶段1 | 绿灯 | 红灯 | 1EH | 10秒 |
| 10-10.5秒 | 阶段2 | 黄灯亮 | 红灯 | 2EH | 0.5秒 |
| 10.5-11秒 | 阶段2 | 黄灯灭 | 红灯 | 3EH | 0.5秒 |
| 11-11.5秒 | 阶段2 | 黄灯亮 | 红灯 | 2EH | 0.5秒 |
| 11.5-12秒 | 阶段2 | 黄灯灭 | 红灯 | 3EH | 0.5秒 |
| ... | ... | ... | ... | ... | ... |
| 14.5-15秒 | 阶段2 | 黄灯灭 | 红灯 | 3EH | 0.5秒 |
| 15-25秒 | 阶段3 | 红灯 | 绿灯 | 33H | 10秒 |
| 25-25.5秒 | 阶段4 | 红灯 | 黄灯亮 | 35H | 0.5秒 |
| 25.5-26秒 | 阶段4 | 红灯 | 黄灯灭 | 37H | 0.5秒 |
| ... | ... | ... | ... | ... | ... |
| 29.5-30秒 | 阶段4 | 红灯 | 黄灯灭 | 37H | 0.5秒 |
| **完整周期** | **30秒** | - | - | - | **循环往复** |

#### 5.5 NMI中断向量表设置

| 内存地址 | 存储内容 | 说明 |
|---------|---------|------|
| 0000:0008H | OFFSET NMI_ISR | 中断服务程序偏移地址 (IP) |
| 0000:000AH | SEG NMI_ISR | 中断服务程序段地址 (CS) |

---

### 六、实验现象与分析

#### 实验现象：

1. **阶段1（0-10秒）**：
   - 南北方向绿灯点亮，东西方向红灯点亮
   - 持续10秒稳定显示

2. **阶段2（10-15秒）**：
   - 南北方向黄灯以0.5秒为周期闪烁5次
   - 东西方向红灯保持点亮
   - 闪烁效果：亮0.5秒 → 灭0.5秒，共5次

3. **阶段3（15-25秒）**：
   - 南北方向红灯点亮，东西方向绿灯点亮
   - 持续10秒稳定显示

4. **阶段4（25-30秒）**：
   - 南北方向红灯保持，东西方向黄灯闪烁5次
   - 闪烁效果同阶段2

5. **循环运行**：
   - 完成一个30秒周期后，自动回到阶段1
   - 无限循环运行，模拟真实交通灯系统

---

#### 原理分析：

**1. 交通灯状态编码原理**

PA口6位分别控制6个LED，采用低电平点亮方式：
- 南北方向：PA5（绿）、PA4（黄）、PA3（红）
- 东西方向：PA2（绿）、PA1（黄）、PA0（红）

以"南北绿灯，东西红灯"为例：
```
需要: 南北绿=亮(0), 南北黄=灭(1), 南北红=灭(1)
      东西绿=灭(1), 东西黄=灭(1), 东西红=亮(0)
PA值: 00 011 110 = 1EH
```

**2. 定时系统工作原理**

采用两级定时器级联：
```
100kHz时钟 → 8253 Counter 0 → 1kHz方波 → 8253 Counter 2 → NMI中断
              (方式3, ÷100)              (方式0, ÷1000或÷500)
```

- Counter 0：方式3方波发生器，产生稳定的1kHz时基信号
- Counter 2：方式0计数结束中断，根据需要设置不同计数初值
  - 1秒定时：初值1000 (BCD)
  - 0.5秒定时：初值500 (BCD)

**3. NMI中断机制**

- Counter 2计数到0时，OUT2输出高电平，触发CPU的NMI引脚
- NMI是不可屏蔽中断，不受IF标志控制，响应优先级最高
- 中断服务程序设置delay_flag=1，通知主程序定时完成
- 主程序通过轮询delay_flag标志等待定时完成

**4. 黄灯闪烁实现**

使用LOOP指令实现循环闪烁：
```assembly
MOV CX, 5                    ; 闪烁5次
NS_YELLOW_BLINK:
    PUSH CX
    ; 黄灯亮 → 延时0.5秒
    MOV AL, LIGHT_NS_YELLOW_EW_RED
    CALL SET_LIGHT
    CALL DELAY_HALF_SECOND
    ; 黄灯灭 → 延时0.5秒
    MOV AL, LIGHT_NS_OFF_EW_RED
    CALL SET_LIGHT
    CALL DELAY_HALF_SECOND
    POP CX
    LOOP NS_YELLOW_BLINK     ; CX-1，继续循环
```

每次循环：亮0.5秒 + 灭0.5秒 = 1秒，循环5次共5秒

**5. 模块化程序设计**

程序采用子程序模块化设计：
- INIT_NMI：初始化中断向量表
- INIT_8255：初始化并行接口
- INIT_8253_CNT0：初始化时基发生器
- SET_LIGHT：设置灯状态（封装OUT指令）
- DELAY_SECONDS：秒级延时
- DELAY_HALF_SECOND：半秒延时
- NMI_ISR：中断服务程序

优点：
- 代码结构清晰，易于理解和维护
- 功能模块独立，便于调试和复用
- 主程序逻辑简洁，可读性强

**6. 标志位轮询方式**

使用delay_flag标志实现主程序与中断的通信：
```assembly
MOV delay_flag, 0           ; 主程序清除标志
WAIT_1S:
    CMP delay_flag, 1       ; 轮询检查标志
    JNE WAIT_1S             ; 未置位则继续等待

; 中断服务程序
NMI_ISR:
    MOV delay_flag, 1       ; 置位标志，通知主程序
    IRET
```

这种方式简单可靠，适合定时控制应用。

---

**成绩：**

**批阅教师：** ————————

**日    期：** ————————
